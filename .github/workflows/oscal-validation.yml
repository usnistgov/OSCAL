name: OSCAL Validation

on:
  push:
    branches: [ main, add-171a-plan ]

jobs:
  validate-oscal:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: false
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'
    
    - name: Setup OSCAL CLI
      uses: oscal-club/oscal-cli-action@v2.0.1
      with:
        args: --version
    
    - name: Validate Catalogs
      run: |
        for file in $(find . -name "*catalog*.json" 2>/dev/null); do
          if [ -f "$file" ]; then
            echo "Validating: $file"
            oscal-cli catalog validate "$file"
          fi
        done
      continue-on-error: true
    
    - name: Validate Profiles
      run: |
        for file in $(find . -name "*profile*.json" 2>/dev/null); do
          if [ -f "$file" ]; then
            echo "Validating: $file"
            oscal-cli profile validate "$file"
          fi
        done
      continue-on-error: true
    
- name: Validate Assessment Plans
  shell: bash
  run: |
    set -euo pipefail
    shopt -s nullglob
    files=( $(git ls-files '*assessment-plan*.json') )
    if ((${#files[@]} == 0)); then
      echo "No assessment-plan JSON files found. Skipping."
      exit 0
    fi
    for file in "${files[@]}"; do
      echo "Validating: $file"
      oscal-cli validate "$file"
    done
  continue-on-error: true

- name: Validate Assessment Results
  shell: bash
  run: |
    set -euo pipefail
    shopt -s nullglob
    files=( $(git ls-files '*assessment-results*.json') )
    if ((${#files[@]} == 0)); then
      echo "No assessment-results JSON files found. Skipping."
      exit 0
    fi
    for file in "${files[@]}"; do
      echo "Validating: $file"
      oscal-cli validate "$file"
    done
  continue-on-error: true

- name: Validate POAMs
  shell: bash
  run: |
    set -euo pipefail
    shopt -s nullglob
    files=( $(git ls-files '*poam*.json') )
    if ((${#files[@]} == 0)); then
      echo "No POAM JSON files found. Skipping."
      exit 0
    fi
    for file in "${files[@]}"; do
      echo "Validating: $file"
      oscal-cli validate "$file"
    done
  continue-on-error: true

